import umap from"/uncdn/https://unpkg.com/umap@^1.0.2?module";import instrument from"/uncdn/https://unpkg.com/uparser@^0.2.1?module";import{isArray}from"/uncdn/https://unpkg.com/uarray@^1.0.0?module";import{persistent}from"/uncdn/https://unpkg.com/uwire@^1.0.1?module";import{handlers}from"./handlers.js?module";import{createFragment,createPath,createWalker,importNode}from"./node.js?module";const prefix="isµ",cache=umap(new WeakMap);export const createCache=()=>({stack:[],entry:null,wire:null});const createEntry=(t,e)=>{const{content:n,updates:r}=mapUpdates(t,e);return{type:t,template:e,content:n,updates:r,wire:null}},mapTemplate=(t,e)=>{const n=instrument(e,"isµ","svg"===t),r=createFragment(n,t),a=createWalker(r),o=[],s=e.length-1;let l=0,p="isµ"+l;for(;l<s;){const t=a.nextNode();if(!t)throw"bad template: "+n;if(8===t.nodeType)t.textContent===p&&(o.push({type:"node",path:createPath(t)}),p="isµ"+ ++l);else{for(;t.hasAttribute(p);)o.push({type:"attr",path:createPath(t),name:t.getAttribute(p)}),t.removeAttribute(p),p="isµ"+ ++l;/^(?:style|textarea)$/i.test(t.tagName)&&t.textContent.trim()===`\x3c!--${p}--\x3e`&&(o.push({type:"text",path:createPath(t)}),p="isµ"+ ++l)}}return{content:r,nodes:o}},mapUpdates=(t,e)=>{const{content:n,nodes:r}=cache.get(e)||cache.set(e,mapTemplate(t,e)),a=importNode.call(document,n,!0);return{content:a,updates:r.map(handlers,a)}};export const unroll=(t,{type:e,template:n,values:r})=>{const{length:a}=r;unrollValues(t,r,a);let{entry:o}=t;o&&o.template===n&&o.type===e||(t.entry=o=createEntry(e,n));const{content:s,updates:l,wire:p}=o;for(let t=0;t<a;t++)l[t](r[t]);return p||(o.wire=persistent(s))};const unrollValues=({stack:t},e,n)=>{for(let r=0;r<n;r++){const n=e[r];n instanceof Hole?e[r]=unroll(t[r]||(t[r]={stack:[],entry:null,wire:null}),n):isArray(n)?unrollValues(t[r]||(t[r]={stack:[],entry:null,wire:null}),n,n.length):t[r]=null}n<t.length&&t.splice(n)};export function Hole(t,e,n){this.type=t,this.template=e,this.values=n}